<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>安裝 Percona XtraDB Cluster</title>
  <meta name="description" content="很簡單地說，Percona XtraDB Cluster 就是 MySQL 打上了一些特殊的 patch，讓 MySQL 可以將某一節點上的寫入動作，重製到其他節點上。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://zx1986.github.io/blog/setup-percona-xtradb-cluster.html">
  <link rel="alternate" type="application/rss+xml" title="張旭" href="http://zx1986.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">張旭</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">安裝 Percona XtraDB Cluster</h1>
    <p class="post-meta">May 25, 2013</p>
  </header>

  <article class="post-content">
    <p>很簡單地說，Percona XtraDB Cluster 就是 MySQL 打上了一些特殊的 patch，<br />
讓 MySQL 可以將某一節點上的寫入動作，重製到其他節點上。</p>

<h2 id="section">背景知識</h2>

<h4 id="codership">Codership</h4>

<p><a href="http://www.codership.com/company/">Codership</a> 是一家成立於 2007 年的公司，公司的 Founder 都是 Database 專家。<br />
Codership 致力於研究及實做高擴展性且快速的資料庫同步機制（Replication），<br />
並帶頭制定了名爲 WSREP 的 API 標準，且根據這套 API 實做了 Galera 同步器（Replicator）。</p>

<h4 id="wsrepwrite-set-replication">WSREP（Write Set REPlication）</h4>

<p><a href="https://launchpad.net/wsrep/">WSREP</a> 是一個爲 DBMS（DataBase Management System）設計的 API 標準，<br />
它爲 DBMS 類型的應用程式建立了一個 Replication 介面（Interface），<br />
這個介面位於 DBMS 軟體與 Replication Servcie Provider（即 Replicator）之間。<br />
<a href="https://launchpad.net/wsrep-group/">WSREP Group</a> 是討論與建立這個標準的開放性羣組。</p>

<blockquote>
  <p>WSREP API defines a set of application callbacks and replication library calls necessary to implement synchronous writeset replication of transactional databases and similar applications. It aims to abstract and isolate replication implementation from application details.</p>
</blockquote>

<h4 id="galera-replicator">Galera Replicator</h4>

<p><a href="https://launchpad.net/galera/">Galera</a> 是一套根據 WSREP 標準實做出來的 Replication 函式庫。<br />
Galera 的運作架構可以參考<a href="http://www.codership.com/products/galera_replication/">它們的說明</a>。大致的原則是：<br />
當對 Cluster 中其中一個節點做寫入（Write）時，<br />
Galera 會自動將寫入動作 Replicate 到 Cluster 其他的節點上。</p>

<blockquote>
  <p>Galera implements WSREP pluggable interface, and can provide several replication modes and topologies, including the ultimate Synchronous Multi-Master replication.</p>
</blockquote>

<h4 id="mysql-galera-cluster">MySQL Galera Cluster</h4>

<p>傳統的 <a href="http://www.codership.com/products/mysql_galera/">MySQL Server</a> 只要打上 WSREP 的 Patch，支援了 WSREP 介面，<br />
再搭配使用 Galera 函式庫，調整好設定檔，就可以組出一個 Cluster。</p>

<blockquote>
  <p>MySQL/Galera cluster uses Galera library for the replication implementation. To interface with Galera replication, we have enhanced MySQL server to support replication API definition in the wsrep API project.</p>
</blockquote>

<h4 id="mariadb-galera-cluster">MariaDB Galera Cluster</h4>

<p>相較於 MySQL 要額外打 Patch，MariaDB 直接推出包好的 <a href="https://downloads.mariadb.org/mariadb-galera/">MariaDB Galera Cluster</a>，<br />
MariaDB 還針對不同的 Linux 發佈版提供了<a href="https://downloads.mariadb.org/mariadb/repositories/">套件庫</a>。<br />
它是 Percona XtraDB Cluster 之外的另一個選擇。</p>

<h4 id="percona-xtradb-clusterpxc">Percona XtraDB Cluster（PXC）</h4>

<p>Percona 是一家專業的 MySQL 顧問與技術公司，<br />
他們有一個很知名的 MySQL Blog：<a href="http://www.mysqlperformanceblog.com">MySQL Performance</a>；<br />
Percona 也開發了許多知名的<a href="http://www.percona.com/software">資料庫工具與軟體</a>。</p>

<p>XtraDB 是 Percona 基於 InnoDB 改良出來的一個資料庫引擎。<br />
在 XtraDB 引擎的基礎上，Percona 發佈了一個修改過的 MySQL：Percona Server，<br />
而 Percona XtraDB Cluster 則是 Percona Server + Galera Library 的整合產品。<br />
Percona XtraDB Cluster 的資料庫同步機制是靠 Galera 完成的（即 Write Replication）。</p>

<h2 id="percona-xtradb-cluster">安裝 Percona XtraDB Cluster</h2>

<p>最新的 XtraDB 安裝檔：   <br />
<a href="http://www.percona.com/downloads/Percona-XtraDB-Cluster/LATEST/">Percona XtraDB Cluster</a>   <br />
<a href="http://www.percona.com/downloads/XtraBackup/LATEST/">XtraBackup</a></p>

<p>以 Red Hat 環境（RHEL，Cent OS）爲例。</p>

<pre><code>rpm -Uhv http://www.percona.com/downloads/percona-release/percona-release-0.0-1.x86_64.rpm
yum install Percona-XtraDB-Cluster-server Percona-XtraDB-Cluster-client percona-xtrabackup
vim /etc/my.cnf

    [mysqld]
    wsrep_provider=/usr/lib64/libgalera_smm.so
    wsrep_cluster_name=叢集的名稱
    wsrep_cluster_address=gcomm://節點一的位址,節點二的位址,節點三的位址
    wsrep_slave_threads=4
    wsrep_sst_method=rsync
    binlog_format=ROW
    default_storage_engine=InnoDB
    innodb_autoinc_lock_mode=2
    innodb_locks_unsafe_for_binlog=1

service mysql start --wsrep-cluster-address="gcomm://"
mysql -e "CREATE FUNCTION fnv1a_64 RETURNS INTEGER SONAME 'libfnv1a_udf.so'"
mysql -e "CREATE FUNCTION fnv_64 RETURNS INTEGER SONAME 'libfnv_udf.so'"
mysql -e "CREATE FUNCTION murmur_hash RETURNS INTEGER SONAME 'libmurmur_udf.so'"
mysqladmin -u root password '12345678'
service mysql stop
service mysql start
mysql -u root -p
mysql&gt; show status like 'wsrep_%';
</code></pre>

<p>以上是第一個節點的設定，其他節點只要重複到啓動 MySQL 那個步驟，<br />
並將啓動的指令改爲：<code>service mysql start</code></p>

<ul>
  <li><code>--wsrep-cluster-address="gcomm://"</code> 參數代表初始化一個全新的叢集！</li>
</ul>

<h4 id="sst">SST</h4>

<blockquote>
  <p>State Snapshot Transfer is the full copy of data from one node to another.</p>
</blockquote>

<p>SST 是 State Snapshot Transfer 的縮寫，指的是 PXC 各節點間同步資料的方式。<br />
可以在 /etc/my.cnf 中透過 wsrep_sst_method 參數來設定。<br />
PXC 有三種同步方式，分別是：</p>

<ul>
  <li>wsrep_sst_method=mysqldump</li>
</ul>

<blockquote>
  <p>If you use mysqldump SST it should be the same as this mysql client connection address plus you need to set wsrep_sst_auth variable to hold user:password pair. The user should be privileged enough to read system tables from donor and create system tables on this node. For simplicity that could be just the root user. Note that it also means that you need to properly set up the privileges on the new node before attempting to join the cluster.</p>
</blockquote>

<ul>
  <li>wsrep_sst_method=rsync</li>
</ul>

<blockquote>
  <p>If you use rsync SST, wsrep_sst_auth is not necessary unless your SST script makes use of it.</p>
</blockquote>

<ul>
  <li>wsrep_sst_method=xtrabackup</li>
</ul>

<blockquote>
  <p>If you use xtrabackup as SST method, it will use /usr/bin/wsrep_sst_xtrabackup provided in Percona-XtraDB-Cluster-server package. And this script also needs user password if you have a password for root@localhost.</p>
</blockquote>

<p>要使用 <a href="http://serverfault.com/questions/389190/xtrabackup-for-sst-with-xtradb-cluster">xtrabackup 當作 SST method</a> 時，<br />
需要設定 Database 的 root password 到 /etc/my.cnf 內，<br />
例如：<code>wsrep_sst_auth=root:12345678</code></p>

<p>PXC 官方手冊：<br />
<a href="http://www.percona.com/doc/percona-xtradb-cluster/installation.html">http://www.percona.com/doc/percona-xtradb-cluster/installation.html</a><br />
<a href="http://www.percona.com/doc/percona-xtradb-cluster/manual/bootstrap.html">http://www.percona.com/doc/percona-xtradb-cluster/manual/bootstrap.html</a></p>

<p>PXC 專有名詞：<br />
<a href="http://www.percona.com/doc/percona-xtradb-cluster/glossary.html">http://www.percona.com/doc/percona-xtradb-cluster/glossary.html</a></p>

<p>Reference：<br />
<a href="http://www.mysqlperformanceblog.com/2013/01/29/how-to-start-a-percona-xtradb-cluster/">http://www.mysqlperformanceblog.com/2013/01/29/how-to-start-a-percona-xtradb-cluster/</a><br />
<a href="http://www.percona.com/files/presentations/WEBINAR-percona-xtradb-cluster-installation-and-setup.pdf">http://www.percona.com/files/presentations/WEBINAR-percona-xtradb-cluster-installation-and-setup.pdf</a></p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <!-- <h2 class="footer-heading">about.me/zx1986</h2> -->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>張旭</li>
          <li><a href="mailto:zx1986@gmail.com">zx1986@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/zx1986">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">zx1986</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/zx1986">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">zx1986</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Web Developer, Script Coder, Daylight Dreamer</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
